<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Battle Ã  la carte â€“ æ­£å¼ãƒ«ãƒ¼ãƒ«ãƒ‡ãƒ¢ï¼ˆCPUæˆ¦ï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f19; --ink:#eef2ff; --mut:#a1a8b5; --line:#ffffff1a;
    --card:#11162a; --glass:#ffffff0a;
    --pri:#f59e0b; --good:#10b981; --bad:#ef4444; --info:#60a5fa; --vio:#a855f7;
    --r:18px;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:"Noto Sans JP",system-ui; color:var(--ink); background:radial-gradient(900px 400px at 90% -10%, #1e293b 0%, transparent 60%), var(--bg)}
  a{color:inherit; text-decoration:none}
  .wrap{max-width:1080px; margin:0 auto; padding:18px}
  .top{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
  .btn{padding:10px 16px; border-radius:12px; border:1px solid #ffffff24; background:#ffffff12; color:var(--ink); font-weight:700; cursor:pointer}
  .btn:hover{border-color:#ffffff55}
  .btn.primary{background:linear-gradient(135deg, var(--pri), #ef4444); border:none; color:white; box-shadow:0 8px 24px #00000040}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:900px){ .row{grid-template-columns:1fr} }
  .area{background:var(--glass); border:1px solid var(--line); border-radius:var(--r); padding:14px}
  .who{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px}
  .tags{display:flex; gap:8px; flex-wrap:wrap}
  .tag{padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#ffffff10; font-weight:700; font-size:12px}
  .tag.on{background:#10b98133; border-color:#10b981aa}
  .hand,.set{display:flex; gap:10px; flex-wrap:wrap}
  .card{
    min-width:140px; max-width:170px; padding:10px; border-radius:16px; border:1px solid #ffffff18;
    background:#101630; box-shadow:0 8px 24px #00000030; position:relative;
  }
  .card .name{font-weight:800}
  .card .desc{color:var(--mut); font-size:13px}
  .card .type{position:absolute; top:8px; right:8px; font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid #ffffff25; background:#ffffff14}
  .type.mat{border-color:#22c55e66} .type.evt{border-color:#60a5fa66} .type.proc{border-color:#f59e0b66}
  .back{width:110px; height:80px; border-radius:12px; border:1px solid var(--line); background:#0c1224; display:grid; place-items:center}
  .mut{color:var(--mut)}
  .pile{display:flex; align-items:center; gap:12px}
  .pile .box{width:60px; height:84px; border-radius:12px; border:2px dashed var(--line); display:grid; place-items:center}
  .log{height:240px; overflow:auto; background:#0c1224; border:1px dashed #ffffff22; border-radius:12px; padding:10px; font-size:14px}
  .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .right{display:flex; gap:8px; align-items:center}
  .small{font-size:12px}
  .danger{color:#fca5a5}
  .ok{color:#86efac}
  dialog{border:none; border-radius:16px; padding:0; max-width:680px; width:min(92vw,680px)}
  .dlg{padding:16px; background:#0f142a; color:var(--ink); border:1px solid var(--line); border-radius:16px}
  .list{display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px}
  .hr{height:1px; background:var(--line); margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>ğŸ³ Battle Ã  la carte â€” æ­£å¼ãƒ«ãƒ¼ãƒ«ãƒ‡ãƒ¢ï¼ˆCPUæˆ¦ï¼‰</h1>
    <div class="right">
      <button class="btn" id="btnCraft">å½¹ã‚’ä½œã‚‹</button>
      <button class="btn" id="btnBuy">åŠ å·¥ã‚«ãƒ¼ãƒ‰</button>
      <button class="btn" id="btnEnd">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
      <button class="btn" id="btnNew">ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ </button>
      <a class="btn" href="index.html">â† ãƒ›ãƒ¼ãƒ </a>
    </div>
  </div>

  <div class="area">
    <div class="pile">
      <div class="box">å±±æœ­<br><b id="deckN">0</b></div>
      <div class="box">ã‚´ãƒŸç®±<br><b id="discN">0</b></div>
      <div class="mut">ã‚¿ãƒ¼ãƒ³ï¼š<b id="turnLabel">ã‚ãªãŸ</b>ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼š<span id="evtRest">OK</span>ï¼‰</div>
      <div class="mut">å…ˆæ‰‹ã‚¤ãƒ™ãƒ³ãƒˆåˆ¶é™ï¼š<b id="firstLock">-</b></div>
    </div>
  </div>

  <div class="row">
    <!-- CPU -->
    <section class="area">
      <div class="who">
        <h3>ğŸ¤– CPU</h3>
        <div class="mut">æ‰‹æœ­ <b id="cpuHandN">0</b> / ã‚»ãƒƒãƒˆ <b id="cpuSetN">0</b> / å¾—ç‚¹ <b id="cpuPts">0</b></div>
      </div>
      <div class="tags" id="cpuProcs"></div>
      <div class="mut small">â€»CPUã®æ‰‹æœ­ã¯éå…¬é–‹ / ã‚»ãƒƒãƒˆã¯è£å‘ã</div>
      <div class="set" id="cpuSet"></div>
    </section>

    <!-- YOU -->
    <section class="area">
      <div class="who">
        <h3>ğŸ§‘ ã‚ãªãŸ</h3>
        <div class="mut">æ‰‹æœ­ <b id="youHandN">0</b> / ã‚»ãƒƒãƒˆ <b id="youSetN">0</b> / å¾—ç‚¹ <b id="youPts">0</b></div>
      </div>
      <div class="tags" id="youProcs"></div>

      <h4 style="margin:.4rem 0 0 0;">æ‰‹æœ­</h4>
      <div class="hand" id="youHand"></div>

      <div class="hr"></div>
      <h4 style="margin:.2rem 0 0 0;">ã‚»ãƒƒãƒˆï¼ˆè£å‘ãï¼‰</h4>
      <div class="set" id="youSet"></div>
      <div class="mut small">ã‚»ãƒƒãƒˆã¯é€šå¸¸2æšã¾ã§ï¼ˆå†·å‡åº«ã§3ï¼‰ã€‚ã‚¤ãƒ™ãƒ³ãƒˆä»¥å¤–ã§äº¤æ›ä¸å¯ã€‚è‡ªåˆ†ã ã‘ä¸­èº«ã‚’ç¢ºèªã§ãã¾ã™ã€‚</div>
    </section>
  </div>

  <section class="area">
    <h3 style="margin:0 0 6px 0;">ãƒ­ã‚°</h3>
    <div id="log" class="log"></div>
    <p class="mut small" style="margin:.5rem 0 0 0">
      ãƒ«ãƒ¼ãƒ«ï¼šé–‹å§‹æ™‚4æšé…å¸ƒã€‚è‡ªåˆ†ã®ç•ªã®ãƒ‰ãƒ­ãƒ¼ã§ä¸Šé™ï¼ˆé€šå¸¸4ï¼ã¾ãªæ¿æ‰€æŒã§5ï¼‰ã¾ã§å¼•ãã€‚ã‚¤ãƒ™ãƒ³ãƒˆã¯å„ã‚¿ãƒ¼ãƒ³1å›ã€‚å½¹ã‚’ä½œã‚‹ã¨ä½¿ç”¨æœ­ã¯ã‚´ãƒŸç®±ã¸ã€‚10ç‚¹ã§å‹åˆ©ã€‚<br>
      ç‰¹æ®Šå‹åˆ©ï¼šæ–™ç†ã®é‰„äººï¼ˆ4è‚‰ã‚’å„1å›ä»¥ä¸Šå«ã‚€å½¹ï¼‹åˆè¨ˆ7ç‚¹ï¼‰ã€æº€è…¹ã®é”äººï¼ˆåŒä¸€ã‚¿ãƒ¼ãƒ³3å½¹ï¼‰ã€‚
    </p>
  </section>
</div>

<!-- å½¹ã¥ãã‚Šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<dialog id="dlgCraft"><div class="dlg">
  <h3>å½¹ã‚’ä½œã‚‹</h3>
  <div class="mut small">æ‰‹æœ­ã¨è‡ªåˆ†ã®ã‚»ãƒƒãƒˆã‹ã‚‰ææ–™ã‚’ä½¿ã£ã¦ãƒ¬ã‚·ãƒ”ã‚’æˆç«‹ã•ã›ã¾ã™ã€‚åŒ…ä¸æ‰€æŒãªã‚‰ææ–™1æšã‚’2æšåˆ†ã¨ã—ã¦ä½¿ç”¨å¯ã€‚</div>
  <div class="hr"></div>
  <div id="craftList" class="list"></div>
  <div class="hr"></div>
  <div class="flex">
    <button class="btn" id="closeCraft">é–‰ã˜ã‚‹</button>
  </div>
</div></dialog>

<!-- åŠ å·¥ã‚«ãƒ¼ãƒ‰è³¼å…¥ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<dialog id="dlgBuy"><div class="dlg">
  <h3>åŠ å·¥ã‚«ãƒ¼ãƒ‰ã‚’ç²å¾—ï¼ˆå„3ç‚¹ï¼‰</h3>
  <div class="list" id="buyList"></div>
  <div class="hr"></div>
  <button class="btn" id="closeBuy">é–‰ã˜ã‚‹</button>
</div></dialog>

<!-- æ‰‹æœ­2æšæ®‹ã—ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<dialog id="dlgKeep"><div class="dlg">
  <h3>ã‚¿ãƒ¼ãƒ³çµ‚äº†ï¼šæ‰‹æœ­ã‚’2æšã ã‘æ®‹ã—ã¦ãã ã•ã„</h3>
  <div id="keepList" class="list"></div>
  <div class="hr"></div>
  <div class="flex">
    <button class="btn primary" id="confirmKeep">æ±ºå®š</button>
  </div>
</div></dialog>

<script>
/* ====== ãƒ‡ãƒ¼ã‚¿å®šç¾© ====== */
const MATERIAL_COUNTS = {
  "ã”é£¯":4, "ã®ã‚Š":4, "ç‰›ä¹³":4,
  "ãƒãƒŠãƒŠ":2, "ã‚«ãƒ¬ãƒ¼ç²‰":2,
  "é¶è‚‰":2, "è±šè‚‰":2, "ç‰›è‚‰":2, "é­šè‚‰":2,
  "åµ":2, "ã‚­ãƒ£ãƒ™ãƒ„":2, "ã«ã‚“ã˜ã‚“":2, "ã˜ã‚ƒãŒã„ã‚‚":2, "ç‰ã­ã":2, "å¤§æ ¹":2
};

const EVENTS = [
  {id:"ã”ã¿", name:"ã‚´ãƒŸåé›†è»Š", desc:"ã‚´ãƒŸç®±ã‹ã‚‰ææ–™1æšã‚’æ‰‹æœ­ã¸", once:true},
  {id:"ç‰©ã€…", name:"ç‰©ã€…äº¤æ›", desc:"ç›¸æ‰‹ã®æ‰‹æœ­ã‚’è¦‹ã¦ææ–™1æšã‚’ã‚‚ã‚‰ã„ã€è‡ªåˆ†ã®ææ–™1æšã‚’æ¸¡ã™", once:true},
  {id:"ã‚„ã‚", name:"ã‚„ã£ã±ã‚„ãƒ¼ã‚ãŸã£ï¼", desc:"è‡ªåˆ†ã®ã‚»ãƒƒãƒˆä¸­ã®ææ–™ã‚’ã™ã¹ã¦æ‰‹æœ­ã«æˆ»ã™", once:true},
  {id:"ã‚„ã‚Š", name:"ã‚„ã‚Šç›´ã—", desc:"è‡ªåˆ†ã®æ‰‹æœ­ã‚’ã™ã¹ã¦æ¨ã¦ã€åŒæšæ•°å¼•ã", once:true},
  {id:"å‰µä½œ", name:"å‰µä½œæ–™ç†", desc:"ææ–™2æšã‚’æ¨ã¦3ç‚¹ç²å¾—ã€‚ã“ã®ã‚¿ãƒ¼ãƒ³ä»–ã®å½¹ä¸å¯", once:true, lock:true},
  {id:"çˆ†è²·", name:"çˆ†è²·ã„", desc:"å±±æœ­ã‹ã‚‰3æšå¼•ã", once:true},
  {id:"æ¢ç´¢", name:"é£Ÿææ¢ç´¢", desc:"å±±ã‹ã‚‰3æšå…¬é–‹â†’ææ–™ãŒã‚ã‚Œã°2æšã¾ã§æ‰‹æœ­ã¸", once:true},
  {id:"æƒé™¤", name:"å¤§æƒé™¤", desc:"ç›¸æ‰‹ã®æ‰‹æœ­ã‚’å…¨æ¨ã¦â†’åŒæšæ•°å¼•ã", once:true},
  {id:"ç·Šæ€¥", name:"ç·Šæ€¥èª¿ç†", desc:"è‡ªåˆ†ã®å¾—ç‚¹ãŒ5ç‚¹ä»¥ä¸‹ã®ã¨ãã€ææ–™1æšã¨ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦3ç‚¹ï¼ˆä»–ã®å½¹ä¸å¯ï¼‰", once:true, lock:true},
];

const PROCS = [
  {id:"knife",   name:"åŒ…ä¸",   desc:"å½¹ä½œæˆæ™‚ã€ææ–™1æšã‚’2æšåˆ†ã¨ã—ã¦æ‰±ãˆã‚‹"},
  {id:"freezer", name:"å†·å‡åº«", desc:"è‡ªåˆ†ã®ã‚»ãƒƒãƒˆä¸Šé™+1ï¼ˆåˆè¨ˆ3ï¼‰"},
  {id:"board",   name:"ã¾ãªæ¿", desc:"ãƒ‰ãƒ­ãƒ¼ä¸Šé™+1ï¼ˆåˆè¨ˆ5ï¼‰"},
];

const RECIPES = [
  // 1ç‚¹
  {name:"ãŠã«ãã‚Š", pts:1, need:{"ã”é£¯":1,"ã®ã‚Š":1}},
  {name:"åµã‹ã‘ã”é£¯", pts:1, need:{"ã”é£¯":1,"åµ":1}},
  {name:"è±šãƒãƒ©å¤§æ ¹", pts:1, need:{"è±šè‚‰":1,"å¤§æ ¹":1}},
  {name:"ãƒ–ãƒªå¤§æ ¹", pts:1, need:{"é­šè‚‰":1,"å¤§æ ¹":1}},
  {name:"ãƒ­ãƒ¼ãƒ«ã‚­ãƒ£ãƒ™ãƒ„", pts:1, need:{"è±šè‚‰":1,"ã‚­ãƒ£ãƒ™ãƒ„":1}},
  {name:"ãƒãƒŠãƒŠã‚¸ãƒ¥ãƒ¼ã‚¹", pts:1, need:{"ãƒãƒŠãƒŠ":1,"ç‰›ä¹³":1}},
  // 2ç‚¹
  {name:"é®­ãŠã«ãã‚Š", pts:2, need:{"ã”é£¯":1,"ã®ã‚Š":1,"é­šè‚‰":1}},
  {name:"é‡èœç‚’ã‚", pts:2, need:{"ã‚­ãƒ£ãƒ™ãƒ„":1,"ã«ã‚“ã˜ã‚“":1,"ç‰ã­ã":1}},
  {name:"ãƒãƒ£ãƒ¼ãƒãƒ³", pts:2, need:{"ã”é£¯":1,"ç‰ã­ã":1,"åµ":1}},
  // 4ç‚¹
  {name:"è±ªè¯ãªãƒãƒ£ãƒ¼ãƒãƒ³", pts:4, need:{"ã”é£¯":1,"ç‰ã­ã":1,"åµ":1,"è±šè‚‰":1}},
  {name:"ã‚­ãƒ¼ãƒã‚«ãƒ¬ãƒ¼", pts:4, need:{"ã”é£¯":1,"ç‰ã­ã":1,"ã‚«ãƒ¬ãƒ¼ç²‰":1,"ç‰›è‚‰":1}},
  {name:"ã‚ªãƒ ãƒ©ã‚¤ã‚¹", pts:4, need:{"ã”é£¯":1,"ç‰ã­ã":1,"åµ":1,"é¶è‚‰":1}},
  {name:"ãƒãƒ³ãƒãƒ¼ã‚°", pts:4, need:{"ç‰›è‚‰":1,"è±šè‚‰":1,"ç‰ã­ã":1,"ç‰›ä¹³":1}},
  {name:"è‚‰ã˜ã‚ƒãŒ", pts:4, need:{"ç‰›è‚‰":1,"ã˜ã‚ƒãŒã„ã‚‚":1,"ç‰ã­ã":1,"ã«ã‚“ã˜ã‚“":1}},
  // 7ç‚¹
  {name:"ã‚¯ãƒªãƒ¼ãƒ ã‚·ãƒãƒ¥ãƒ¼", pts:7, need:{"ç‰›ä¹³":1,"ç‰›è‚‰":1,"ç‰ã­ã":1,"ã«ã‚“ã˜ã‚“":1,"ã˜ã‚ƒãŒã„ã‚‚":1}},
  {name:"ã‚«ãƒ¬ãƒ¼", pts:7, need:{"ç‰›è‚‰":1,"ç‰ã­ã":1,"ã«ã‚“ã˜ã‚“":1,"ã˜ã‚ƒãŒã„ã‚‚":1,"ã‚«ãƒ¬ãƒ¼ç²‰":1}},
  // 10ç‚¹
  {name:"æº€è…¹ã‚«ãƒ¬ãƒ¼", pts:10, need:{"ã”é£¯":1,"ç‰›è‚‰":1,"ç‰ã­ã":1,"ã«ã‚“ã˜ã‚“":1,"ã˜ã‚ƒãŒã„ã‚‚":1,"ã‚«ãƒ¬ãƒ¼ç²‰":1}},
  {name:"çˆ†å¼¾ãŠã«ãã‚Š", pts:10, need:{"ã”é£¯":4,"ã®ã‚Š":1,"é­šè‚‰":1}},
];

function makeDeck(){
  const deck = [];
  for(const [mat, n] of Object.entries(MATERIAL_COUNTS))
    for(let i=0;i<n;i++) deck.push({kind:"mat", name:mat});
  // ã‚¤ãƒ™ãƒ³ãƒˆå„2æš
  for(const ev of EVENTS) for(let i=0;i<2;i++) deck.push({kind:"evt", id:ev.id, name:ev.name});
  return shuffle(deck);
}

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function shuffle(a){
  const arr = a.slice();
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function countByName(list){
  const m = {};
  for(const c of list){ m[c.name] = (m[c.name]||0)+1; }
  return m;
}
function clone(o){ return JSON.parse(JSON.stringify(o)); }

/* ====== çŠ¶æ…‹ ====== */
let S;

function newGame(){
  S = {
    deck: makeDeck(),
    discard: [],
    firstTurnEventLock: {you:true, cpu:true}, // 2äººæˆ¦ï¼šå…ˆè¡Œã®ã¿åˆæ‰‹ç¦æ­¢ â†’ startæ™‚ã«youå…ˆè¡Œã«ã™ã‚‹
    turn: 'you',
    gameOver:false,
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    you: {hand:[], set:[], pts:0, procs:[], meats:new Set(), evtUsed:false, turnLock:false, craftedThisTurn:0},
    cpu: {hand:[], set:[], pts:0, procs:[], meats:new Set(), evtUsed:false, turnLock:false, craftedThisTurn:0},
  };
  // å…ˆæ”»/å¾Œæ”»ã®å…ˆæ‰‹åˆ¶é™ï¼šä»Šå›ã¯youå…ˆæ”» â†’ youã®ã¿åˆæ‰‹ã‚¤ãƒ™ãƒ³ãƒˆç¦æ­¢
  S.firstTurnEventLock = {you:true, cpu:false};

  // åˆæœŸ4æšãšã¤
  for(let i=0;i<4;i++){ draw('you'); draw('cpu'); }
  logClear();
  log('ğŸ¬ ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ ã‚ãªãŸãŒå…ˆæ”»ã§ã™ã€‚å…ˆæ‰‹ã®åˆæ‰‹ã¯ã‚¤ãƒ™ãƒ³ãƒˆä½¿ç”¨ä¸å¯ã€‚');
  startTurn();
  render();
}

function draw(who){
  // æ‰‹æœ­ä¸Šé™ï¼šé€šå¸¸4ã€ã¾ãªæ¿æŒã¡ã§5
  const limit = hasProc(who,'board') ? 5 : 4;
  while(S[who].hand.length < limit){
    if(S.deck.length===0){
      if(S.discard.length===0) break;
      S.deck = shuffle(S.discard); S.discard = [];
      log('â™»ï¸ å±±æœ­ãŒåˆ‡ã‚ŒãŸãŸã‚ã€ã‚´ãƒŸç®±ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å±±æœ­ã«æˆ»ã—ã¾ã—ãŸã€‚');
    }
    S[who].hand.push(S.deck.pop());
  }
}

function startTurn(){
  const who = S.turn;
  S[who].evtUsed = false;
  S[who].turnLock = false;
  S[who].craftedThisTurn = 0;

  draw(who);
  render();
  if(who==='cpu' && !S.gameOver){
    setTimeout(cpuAct, 700);
  }
}

function endTurn(){
  if(S.gameOver) return;
  const who = S.turn;
  // ã‚¨ãƒ³ãƒ‰æ™‚ã€æ‰‹æœ­ãŒ4æšä»¥ä¸Šãªã‚‰2æšã ã‘æ®‹ã™
  if(S[who].hand.length>2){
    if(who==='you'){ openKeepDialog(); return; }
    cpuDiscardToTwo();
  }
  // ã‚¿ãƒ¼ãƒ³åˆ‡æ›¿
  S.turn = (S.turn==='you')?'cpu':'you';
  // å…ˆæ‰‹ã‚¤ãƒ™ãƒ³ãƒˆåˆ¶é™ã¯ãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€åˆã®çµ‚äº†æ™‚ã«è§£é™¤
  S.firstTurnEventLock[S.turn] = S.firstTurnEventLock[S.turn] && false;
  render();
  startTurn();
}

function openKeepDialog(){
  const dlg = byId('dlgKeep');
  const cont = byId('keepList'); cont.innerHTML='';
  const who = S.turn;
  const hand = S[who].hand;
  const selected = new Set();
  hand.forEach((c,idx)=>{
    const el = docCard(c);
    el.onclick = ()=>{ 
      if(selected.has(idx)){ selected.delete(idx); el.style.outline='none'; }
      else { selected.add(idx); el.style.outline='2px solid #f59e0b'; }
    };
    cont.appendChild(el);
  });
  byId('confirmKeep').onclick = ()=>{
    if(selected.size!==2){ alert('2æšã ã‘é¸ã‚“ã§ãã ã•ã„'); return; }
    const keepIdx = Array.from(selected).sort((a,b)=>a-b);
    const newHand = [hand[keepIdx[0]], hand[keepIdx[1]]];
    // æ¨ã¦ã‚‹
    hand.forEach((c,i)=>{ if(!keepIdx.includes(i)) S.discard.push(c); });
    S[who].hand = newHand;
    dlg.close();
    // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
    S.turn = (S.turn==='you')?'cpu':'you';
    render(); startTurn();
  };
  dlg.showModal();
}

/* ====== å½¹ä½œæˆ ====== */
function canCraft(who, recipe){
  const all = [...S[who].hand, ...S[who].set];
  const cnt = countByName(all);
  const need = clone(recipe.need);
  // åŒ…ä¸ãŒã‚ã‚Œã°ã€ä»»æ„ã®ææ–™1æšã®å¿…è¦æ•°+1ã¶ã‚“ã‚’â€œ1æšã§â€å……è¶³ã§ãã‚‹ï¼ˆ=ä½¿ç”¨æšæ•°-1ã—ã¦OKï¼‰
  const hasKnife = hasProc(who,'knife');
  // ãƒã‚§ãƒƒã‚¯ï¼šåŒ…ä¸ãªã—ã§è¶³ã‚Šã¦ã‚‹ã‹
  let ok = true;
  for(const [k,v] of Object.entries(need)){
    if((cnt[k]||0) < v){ ok=false; break; }
  }
  if(ok) return {ok:true, use:chooseUse(all, need, null)};
  if(!hasKnife) return {ok:false};
  // åŒ…ä¸ã‚ã‚Šï¼šã©ã‚Œã‹1ç¨®ã«ã¤ã„ã¦ã€å¿…è¦æ•°ã‚’1ã ã‘æ¸›ã‚‰ã—ã¦å†åˆ¤å®šï¼ˆææ–™1æšã‚’2æšåˆ†æ‰±ã„ï¼‰
  for(const k of Object.keys(need)){
    const n2 = clone(need); n2[k] = Math.max(0, n2[k]-1);
    let ok2 = true;
    for(const [kk,vv] of Object.entries(n2)){
      if((cnt[kk]||0) < vv){ ok2=false; break; }
    }
    if(ok2) return {ok:true, use:chooseUse(all, n2, {knifeOn:k})};
  }
  return {ok:false};
}

function chooseUse(pool, need, knifeInfo){
  // å®Ÿéš›ã«ä½¿ã†æœ­ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ã‚’æ±ºã‚ã‚‹ã€‚setã‚’å„ªå…ˆçš„ã«æ¶ˆè²»
  const fromSet = [];
  const fromHand = [];
  const hand = S[S.turn].hand, setp = S[S.turn].set;

  const needCnt = clone(need);
  // ã¾ãšã‚»ãƒƒãƒˆã‹ã‚‰
  for(let i=0;i<setp.length;i++){
    const nm = setp[i].name;
    if(needCnt[nm]>0){ needCnt[nm]--; fromSet.push({src:'set', idx:i}); }
  }
  // æ‰‹æœ­ã‹ã‚‰
  for(let i=0;i<hand.length;i++){
    const nm = hand[i].name;
    if(needCnt[nm]>0){ needCnt[nm]--; fromHand.push({src:'hand', idx:i}); }
  }
  return {fromSet, fromHand, knifeInfo};
}

function doCraft(recipe){
  const who = S.turn;
  if(S[who].turnLock){ alert('ã“ã®ã‚¿ãƒ¼ãƒ³ã¯å½¹ã‚’ä½œã‚Œã¾ã›ã‚“ï¼ˆå‰µä½œæ–™ç†/ç·Šæ€¥èª¿ç†ã®å¾Œï¼‰'); return; }
  const chk = canCraft(who, recipe);
  if(!chk.ok){ alert('å¿…è¦ãªææ–™ãŒè¶³ã‚Šã¾ã›ã‚“'); return; }
  // ä½¿ç”¨æœ­ã‚’ã‚´ãƒŸç®±ã¸ï¼ˆindexãŒãšã‚Œã‚‹ã®ã§æ³¨æ„ï¼‰
  // ã‚»ãƒƒãƒˆâ†’æ‰‹æœ­ã®é †ã§å‡¦ç†
  const setSel = chk.use.fromSet.map(x=>x.idx).sort((a,b)=>b-a);
  for(const i of setSel){ S.discard.push(S[who].set.splice(i,1)[0]); }
  const handSel = chk.use.fromHand.map(x=>x.idx).sort((a,b)=>b-a);
  for(const i of handSel){ S.discard.push(S[who].hand.splice(i,1)[0]); }
  S[who].pts += recipe.pts;
  S[who].craftedThisTurn++;

  // å½¹ã®ä¸­ã«å«ã¾ã‚Œã‚‹è‚‰ç¨®ã‚’è¨˜éŒ²ï¼ˆç‰¹æ®Šå‹åˆ©ç”¨ï¼‰
  for(const meat of ["é¶è‚‰","è±šè‚‰","ç‰›è‚‰","é­šè‚‰"]) if(recipe.need[meat]) S[who].meats.add(meat);

  log(`ğŸ½ï¸ ${whoLabel(who)}ãŒã€Œ${recipe.name}ã€ã‚’å®Œæˆï¼ˆ${recipe.pts}ç‚¹ï¼‰`);
  // å‹åˆ©åˆ¤å®š
  if(S[who].pts >= 10){ gameOver(`${whoLabel(who)}ã®å‹åˆ©ï¼ï¼ˆ10ç‚¹åˆ°é”ï¼‰`); return; }
  // ç‰¹æ®Šå‹åˆ©
  if(S[who].meats.size===4 && S[who].pts>=7){ gameOver(`${whoLabel(who)}ãŒã€Œæ–™ç†ã®é‰„äººã€é”æˆï¼`); return; }
  if(S[who].craftedThisTurn>=3){ gameOver(`${whoLabel(who)}ãŒã€Œæº€è…¹ã®é”äººã€é”æˆï¼`); return; }

  render();
}

/* ====== ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
function canUseEvent(who){
  if(S[who].evtUsed) return false;
  if(S.firstTurnEventLock[who]) return false;
  return true;
}

function useEvent(cardIdx){
  const who = 'you';
  const card = S[who].hand[cardIdx];
  if(!canUseEvent(who)){ alert('ã“ã®ã‚¿ãƒ¼ãƒ³ã¯ã‚‚ã†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ãˆã¾ã›ã‚“ï¼ˆã¾ãŸã¯å…ˆæ‰‹åˆæ‰‹ã®ãŸã‚ä½¿ç”¨ä¸å¯ï¼‰'); return; }
  const ev = EVENTS.find(e=>e.name===card.name);
  if(!ev){ alert('ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

  // åŠ¹æœ
  let consumed = true, lockThisTurn = false;
  switch(ev.id){
    case "ã”ã¿":{
      const mats = S.discard.filter(c=>c.kind==='mat');
      if(mats.length===0){ log('ğŸš› ã‚´ãƒŸç®±ã«ææ–™ãŒã‚ã‚Šã¾ã›ã‚“'); consumed=true; break; }
      // ä¸€è¦§ã‹ã‚‰é¸æŠ
      const names = Array.from(new Set(mats.map(c=>c.name)));
      const pick = prompt(`ã‚´ãƒŸç®±ã‹ã‚‰1æšé¸ã‚“ã§ãã ã•ã„ï¼š\n${names.join(' / ')}`);
      const target = mats.find(c=>c.name===pick) || mats[0];
      // å…ˆã«æ¨ã¦æœ­ã‹ã‚‰å‰Šé™¤
      const i = S.discard.findIndex(c=>c.kind==='mat' && c.name===target.name);
      if(i>=0){ const got = S.discard.splice(i,1)[0]; S[who].hand.push(got); log(`ğŸš› ã‚´ãƒŸåé›†è»Šï¼š${target.name} ã‚’å›å`); }
      break;
    }
    case "ç‰©ã€…":{
      // CPUã®æ‰‹æœ­å…¬é–‹â†’1æšã‚‚ã‚‰ã†ã€ã“ã¡ã‚‰ã‹ã‚‰1æšæ¸¡ã™
      const opp = 'cpu';
      const oppMats = S[opp].hand.filter(c=>c.kind==='mat');
      if(oppMats.length===0){ log('ğŸ” ç›¸æ‰‹ã«ææ–™ãŒã‚ã‚Šã¾ã›ã‚“'); break; }
      const names = oppMats.map(c=>c.name);
      const want = prompt(`ç›¸æ‰‹ã®æ‰‹æœ­ï¼ˆææ–™ï¼‰:\n${names.join(' / ')}\nâ†’ ã‚‚ã‚‰ã†ææ–™åã‚’å…¥åŠ›`);
      const takeIdx = S[opp].hand.findIndex(c=>c.kind==='mat' && c.name===(want||'')); 
      const pickIdx = (takeIdx>=0)?takeIdx : S[opp].hand.findIndex(c=>c.kind==='mat');
      const taken = S[opp].hand.splice(pickIdx,1)[0]; S[who].hand.push(taken);
      // æ¸¡ã™ï¼šã“ã¡ã‚‰ã®ææ–™ãŒç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
      const myMatIdx = S[who].hand.findIndex(c=>c.kind==='mat');
      if(myMatIdx>=0){
        const give = S[who].hand.splice(myMatIdx,1)[0]; S[opp].hand.push(give);
        log(`ğŸ” ç‰©ã€…äº¤æ›ï¼š${whoLabel(who)}ã¯${taken.name}ã‚’å—ã‘å–ã‚Šã€${give.name}ã‚’æ¸¡ã—ãŸ`);
      }else{
        log(`ğŸ” ç‰©ã€…äº¤æ›ï¼š${whoLabel(who)}ã¯${taken.name}ã‚’å—ã‘å–ã£ãŸï¼ˆæ¸¡ã™ææ–™ãªã—ï¼‰`);
      }
      break;
    }
    case "ã‚„ã‚":{
      const n = S[who].set.length;
      if(n===0){ log('â†©ï¸ ã‚»ãƒƒãƒˆã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“'); break; }
      while(S[who].set.length) S[who].hand.push(S[who].set.pop());
      log(`â†©ï¸ ã‚„ã£ã±ã‚„ãƒ¼ã‚ãŸã£ï¼ï¼šã‚»ãƒƒãƒˆã‚’æ‰‹æœ­ã«æˆ»ã—ãŸï¼ˆ${n}æšï¼‰`);
      break;
    }
    case "ã‚„ã‚Š":{
      const n = S[who].hand.length;
      S.discard.push(...S[who].hand.splice(0));
      for(let i=0;i<n;i++){
        if(S.deck.length===0){ S.deck = shuffle(S.discard); S.discard = []; }
        S[who].hand.push(S.deck.pop());
      }
      log('ğŸ”„ ã‚„ã‚Šç›´ã—ï¼šæ‰‹æœ­ã‚’å…¥ã‚Œæ›¿ãˆã¾ã—ãŸ');
      break;
    }
    case "å‰µä½œ":{
      // ææ–™2æšã‚’æ¨ã¦ã¦3ç‚¹
      const myMats = S[who].hand.filter(c=>c.kind==='mat');
      if(myMats.length<2){ alert('ææ–™ãŒ2æšå¿…è¦ã§ã™'); consumed=false; break; }
      // é©å½“ã«å…ˆé ­2æšï¼ˆUIç°¡ç•¥ï¼‰
      const dump = 2;
      let removed=0, keep=[]; 
      for(const c of S[who].hand){
        if(c.kind==='mat' && removed<dump){ S.discard.push(c); removed++; }
        else keep.push(c);
      }
      S[who].hand = keep;
      S[who].pts += 3;
      lockThisTurn = true;
      log('âœ¨ å‰µä½œæ–™ç†ï¼šææ–™2æšâ†’3ç‚¹ï¼ˆã“ã®ã‚¿ãƒ¼ãƒ³ä»–ã®å½¹ä¸å¯ï¼‰');
      if(S[who].pts>=10){ gameOver(`${whoLabel(who)}ã®å‹åˆ©ï¼ï¼ˆ10ç‚¹åˆ°é”ï¼‰`); return; }
      break;
    }
    case "çˆ†è²·":{
      for(let i=0;i<3;i++){
        if(S.deck.length===0){ S.deck = shuffle(S.discard); S.discard = []; }
        if(S.deck.length===0) break;
        S[who].hand.push(S.deck.pop());
      }
      log('ğŸ›’ çˆ†è²·ã„ï¼š3æšãƒ‰ãƒ­ãƒ¼');
      break;
    }
    case "æ¢ç´¢":{
      const open = [];
      for(let i=0;i<3;i++){
        if(S.deck.length===0){ S.deck = shuffle(S.discard); S.discard = []; }
        if(S.deck.length===0) break;
        open.push(S.deck.pop());
      }
      const mats = open.filter(c=>c.kind==='mat');
      const take = mats.slice(0,2);
      const rest = open.filter(c=>!take.includes(c));
      S[who].hand.push(...take);
      S.discard.push(...rest);
      log(`ğŸ” é£Ÿææ¢ç´¢ï¼šå…¬é–‹${open.map(c=>c.name||'ã‚¤ãƒ™ãƒ³ãƒˆ').join('ãƒ»')} â†’ ææ–™${take.length}æšå…¥æ‰‹`);
      break;
    }
    case "æƒé™¤":{
      const opp='cpu'; const n = S[opp].hand.length;
      if(n===0){ log('ğŸ§¹ ç›¸æ‰‹ã®æ‰‹æœ­ãŒã‚ã‚Šã¾ã›ã‚“'); break; }
      S.discard.push(...S[opp].hand.splice(0));
      for(let i=0;i<n;i++){
        if(S.deck.length===0){ S.deck = shuffle(S.discard); S.discard = []; }
        if(S.deck.length===0) break;
        S[opp].hand.push(S.deck.pop());
      }
      log('ğŸ§¹ å¤§æƒé™¤ï¼šç›¸æ‰‹ã®æ‰‹æœ­ã‚’å…¥ã‚Œæ›¿ãˆã•ã›ãŸ');
      break;
    }
    case "ç·Šæ€¥":{
      if(S[who].pts>5){ alert('è‡ªåˆ†ã®å¾—ç‚¹ãŒ5ç‚¹ä»¥ä¸‹ã®ã¨ãã®ã¿ä½¿ç”¨å¯'); consumed=false; break; }
      const matIdx = S[who].hand.findIndex(c=>c.kind==='mat');
      if(matIdx<0){ alert('ææ–™ãŒ1æšå¿…è¦ã§ã™'); consumed=false; break; }
      S.discard.push(S[who].hand.splice(matIdx,1)[0]); // ææ–™
      S[who].pts += 3; lockThisTurn = true;
      log('â± ç·Šæ€¥èª¿ç†ï¼šææ–™1æšâ†’3ç‚¹ï¼ˆã“ã®ã‚¿ãƒ¼ãƒ³ä»–ã®å½¹ä¸å¯ï¼‰');
      if(S[who].pts>=10){ gameOver(`${whoLabel(who)}ã®å‹åˆ©ï¼ï¼ˆ10ç‚¹åˆ°é”ï¼‰`); return; }
      break;
    }
  }
  if(consumed){
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰è‡ªä½“ã‚’æ¨ã¦ã‚‹
    S.discard.push(S[who].hand.splice(cardIdx,1)[0]);
    S[who].evtUsed = true;
    if(ev.lock) S[who].turnLock = true;
  }
  render();
}

function setMaterial(idx){
  const who = 'you';
  const limit = hasProc(who,'freezer') ? 3 : 2;
  if(S[who].set.length>=limit){ alert(`ã‚»ãƒƒãƒˆä¸Šé™ã¯${limit}æšã§ã™ï¼ˆå†·å‡åº«ã§+1ï¼‰`); return; }
  const c = S[who].hand[idx];
  if(c.kind!=='mat'){ alert('ææ–™ã‚«ãƒ¼ãƒ‰ã®ã¿ã‚»ãƒƒãƒˆã§ãã¾ã™'); return; }
  S[who].set.push(c);
  S[who].hand.splice(idx,1);
  render();
}

/* ====== åŠ å·¥ã‚«ãƒ¼ãƒ‰ ====== */
function hasProc(who, id){ return S[who].procs.includes(id); }
function canBuyProc(who, id){ return !hasProc(who,id) && S[who].pts>=3; }
function buyProc(id){
  const who='you';
  if(!canBuyProc(who,id)){ alert('è³¼å…¥ã§ãã¾ã›ã‚“ï¼ˆæ—¢ã«æ‰€æŒ or ç‚¹æ•°ä¸è¶³ï¼‰'); return; }
  S[who].pts -= 3;
  S[who].procs.push(id);
  log(`ğŸ› ï¸ ${whoLabel(who)}ãŒåŠ å·¥ã‚«ãƒ¼ãƒ‰ã€Œ${procName(id)}ã€ã‚’ç²å¾—ï¼ˆ-3ç‚¹ï¼‰`);
  render();
}

/* ====== å‹æ•— ====== */
function whoLabel(w){ return w==='you'?'ã‚ãªãŸ':'CPU'; }
function gameOver(msg){
  S.gameOver = true; log('ğŸ† ' + msg);
  alert('ã‚²ãƒ¼ãƒ çµ‚äº†ï¼š' + ms