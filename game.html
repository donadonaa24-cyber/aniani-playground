<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Battle Ã  la carte â€“ ï¼ˆCPUæˆ¦ï¼‰v0.2</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b0f19;--ink:#eef2ff;--mut:#a1a8b5;--line:#ffffff1a;--card:#11162a;--pri:#f59e0b}
  *{box-sizing:border-box}body{margin:0;font-family:"Noto Sans JP",system-ui;color:var(--ink);background:#0b0f19}
  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  .top{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #ffffff30;background:#ffffff14;color:var(--ink);font-weight:700}
  .btn.primary{background:linear-gradient(135deg,#f59e0b,#ef4444);border:none}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){.row{grid-template-columns:1fr}}
  .area{border:1px solid #ffffff1a;border-radius:16px;padding:12px;background:#0f1425}
  .who{display:flex;align-items:center;justify-content:space-between}
  .hand,.set{display:flex;gap:8px;flex-wrap:wrap}
  .back{width:96px;height:68px;border:1px solid #ffffff2a;border-radius:10px;display:grid;place-items:center;background:#0c1220}
  .card{min-width:140px;max-width:180px;padding:10px;border:1px solid #ffffff20;border-radius:14px;background:#101630}
  .card .name{font-weight:800}.mut{color:var(--mut)}.hr{height:1px;background:#ffffff1a;margin:8px 0}
  .log{height:220px;overflow:auto;background:#0c1220;border:1px dashed #ffffff2a;border-radius:12px;padding:8px;font-size:14px}
  .tags{display:flex;gap:6px;flex-wrap:wrap}.tag{padding:4px 8px;border:1px solid #ffffff25;border-radius:999px;font-size:12px}
  .tag.on{background:#10b98133;border-color:#10b981aa}
  /* ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆdialogä»£æ›¿ï¼‰ */
  .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;padding:16px;z-index:99}
  .sheet{max-width:740px;width:100%;background:#0f142a;border:1px solid #ffffff22;border-radius:16px;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
  .choice{border:1px solid #ffffff25;border-radius:12px;padding:8px;background:#101630}
  .choice.sel{outline:2px solid #f59e0b}
</style>
</head>
<body onload="try{ newGame(); }catch(e){ alert('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: '+e); }">
<div class="wrap">
  <div class="top">
    <h1 style="margin:0">ğŸ³ Battle Ã  la carte â€“ å®‰å…¨ç‰ˆï¼ˆCPUæˆ¦ï¼‰</h1>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button type="button" class="btn" id="btnCraft">å½¹ã‚’ä½œã‚‹</button>
      <button type="button" class="btn" id="btnBuy">åŠ å·¥ã‚«ãƒ¼ãƒ‰</button>
      <button type="button" class="btn" id="btnEnd">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
      <button type="button" class="btn primary" id="btnNew">ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ </button>
      <a class="btn primary" href="game.html?v=3">ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ </a>
    </div>
  </div>

  <div class="area">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div>å±±æœ­ <b id="deckN">0</b> / ã‚´ãƒŸç®± <b id="discN">0</b></div>
      <div class="mut">ã‚¿ãƒ¼ãƒ³ï¼š<b id="turnLabel">-</b>ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼š<span id="evtRest">-</span>ï¼‰</div>
      <div class="mut">å…ˆæ‰‹ã‚¤ãƒ™ãƒ³ãƒˆåˆ¶é™ï¼š<b id="firstLock">-</b></div>
    </div>
  </div>

  <div class="row">
    <section class="area">
      <div class="who"><h3>ğŸ¤– CPU</h3><div class="mut">æ‰‹æœ­ <b id="cpuHandN">0</b> / ã‚»ãƒƒãƒˆ <b id="cpuSetN">0</b> / å¾—ç‚¹ <b id="cpuPts">0</b></div></div>
      <div class="tags" id="cpuProcs"></div>
      <div class="mut">â€»æ‰‹æœ­éå…¬é–‹ãƒ»ã‚»ãƒƒãƒˆã¯è£</div>
      <div class="set" id="cpuSet"></div>
    </section>
    <section class="area">
      <div class="who"><h3>ğŸ§‘ ã‚ãªãŸ</h3><div class="mut">æ‰‹æœ­ <b id="youHandN">0</b> / ã‚»ãƒƒãƒˆ <b id="youSetN">0</b> / å¾—ç‚¹ <b id="youPts">0</b></div></div>
      <div class="tags" id="youProcs"></div>
      <h4>æ‰‹æœ­</h4>
      <div class="hand" id="youHand"></div>
      <div class="hr"></div>
      <h4>ã‚»ãƒƒãƒˆï¼ˆè£å‘ãï¼‰</h4>
      <div class="set" id="youSet"></div>
      <div class="mut">ã‚»ãƒƒãƒˆä¸Šé™2ï¼ˆå†·å‡åº«ã§3ï¼‰ã€‚ã‚¤ãƒ™ãƒ³ãƒˆä»¥å¤–ã§äº¤æ›ä¸å¯ã€‚</div>
    </section>
  </div>

  <section class="area">
    <h3 style="margin:0 0 6px 0;">ãƒ­ã‚°</h3>
    <div id="log" class="log"></div>
  </section>
</div>

<!-- ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šå½¹ã¥ãã‚Š -->
<div class="modal" id="modalCraft">
  <div class="sheet">
    <h3 style="margin:0 0 6px 0">å½¹ã‚’ä½œã‚‹</h3>
    <div class="grid" id="craftList"></div>
    <div class="hr"></div>
    <button class="btn" id="closeCraft">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šåŠ å·¥ -->
<div class="modal" id="modalBuy">
  <div class="sheet">
    <h3 style="margin:0 0 6px 0">åŠ å·¥ã‚«ãƒ¼ãƒ‰ï¼ˆå„3ç‚¹ï¼‰</h3>
    <div class="grid" id="buyList"></div>
    <div class="hr"></div>
    <button class="btn" id="closeBuy">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼š2æšæ®‹ã— -->
<div class="modal" id="modalKeep">
  <div class="sheet">
    <h3 style="margin:0 0 6px 0">æ‰‹æœ­2æšã ã‘æ®‹ã™ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦é¸æŠâ†’æ±ºå®šï¼‰</h3>
    <div class="grid" id="keepList"></div>
    <div class="hr"></div>
    <button class="btn primary" id="confirmKeep">æ±ºå®š</button>
  </div>
</div>

<script>
/* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
var MATERIAL_COUNTS={"ã”é£¯":4,"ã®ã‚Š":4,"ç‰›ä¹³":4,"ãƒãƒŠãƒŠ":2,"ã‚«ãƒ¬ãƒ¼ç²‰":2,"é¶è‚‰":2,"è±šè‚‰":2,"ç‰›è‚‰":2,"é­šè‚‰":2,"åµ":2,"ã‚­ãƒ£ãƒ™ãƒ„":2,"ã«ã‚“ã˜ã‚“":2,"ã˜ã‚ƒãŒã„ã‚‚":2,"ç‰ã­ã":2,"å¤§æ ¹":2};
var EVENTS=[
 {id:"ã”ã¿",name:"ã‚´ãƒŸåé›†è»Š",desc:"ã‚´ãƒŸç®±ã‹ã‚‰ææ–™1æšã‚’æ‰‹æœ­ã¸"},
 {id:"ç‰©ã€…",name:"ç‰©ã€…äº¤æ›",desc:"ç›¸æ‰‹ã®ææ–™ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§1æšã‚‚ã‚‰ã„ã€è‡ªåˆ†ã®ææ–™1æšã‚’æ¸¡ã™ï¼ˆç°¡æ˜“ï¼‰"},
 {id:"ã‚„ã‚",name:"ã‚„ã£ã±ã‚„ãƒ¼ã‚ãŸã£ï¼",desc:"è‡ªåˆ†ã®ã‚»ãƒƒãƒˆã‚’å…¨ã¦æ‰‹æœ­ã«æˆ»ã™"},
 {id:"ã‚„ã‚Š",name:"ã‚„ã‚Šç›´ã—",desc:"æ‰‹æœ­ã‚’å…¨æ¨ã¦â†’åŒæšæ•°ãƒ‰ãƒ­ãƒ¼"},
 {id:"å‰µä½œ",name:"å‰µä½œæ–™ç†",desc:"ææ–™2æšæ¨ã¦â†’3ç‚¹ï¼ˆã“ã®ã‚¿ãƒ¼ãƒ³ä»–å½¹ä¸å¯ï¼‰",lock:true},
 {id:"çˆ†è²·",name:"çˆ†è²·ã„",desc:"3æšãƒ‰ãƒ­ãƒ¼"},
 {id:"æ¢ç´¢",name:"é£Ÿææ¢ç´¢",desc:"å±±ã‹ã‚‰3æšå…¬é–‹â†’ææ–™ãŒã‚ã‚Œã°2æšã¾ã§å…¥æ‰‹"},
 {id:"æƒé™¤",name:"å¤§æƒé™¤",desc:"ç›¸æ‰‹ã®æ‰‹æœ­ã‚’å…¨æ¨ã¦ã•ã›â†’åŒæšæ•°ãƒ‰ãƒ­ãƒ¼"},
 {id:"ç·Šæ€¥",name:"ç·Šæ€¥èª¿ç†",desc:"è‡ªç‚¹5ä»¥ä¸‹ï¼šææ–™1ï¼‹ã“ã®ã‚«ãƒ¼ãƒ‰æ¨ã¦â†’3ç‚¹ï¼ˆä»–å½¹ä¸å¯ï¼‰",lock:true}
];
var PROCS=[{id:"knife",name:"åŒ…ä¸",desc:"å½¹ä½œæˆæ™‚ã€ææ–™1æšã‚’2æšåˆ†æ‰±ã„"},{id:"freezer",name:"å†·å‡åº«",desc:"ã‚»ãƒƒãƒˆä¸Šé™+1ï¼ˆåˆè¨ˆ3ï¼‰"},{id:"board",name:"ã¾ãªæ¿",desc:"ãƒ‰ãƒ­ãƒ¼ä¸Šé™+1ï¼ˆåˆè¨ˆ5ï¼‰"}];
var RECIPES=[
 {name:"ãŠã«ãã‚Š",pts:1,need:{"ã”é£¯":1,"ã®ã‚Š":1}},
 {name:"åµã‹ã‘ã”é£¯",pts:1,need:{"ã”é£¯":1,"åµ":1}},
 {name:"è±šãƒãƒ©å¤§æ ¹",pts:1,need:{"è±šè‚‰":1,"å¤§æ ¹":1}},
 {name:"ãƒ–ãƒªå¤§æ ¹",pts:1,need:{"é­šè‚‰":1,"å¤§æ ¹":1}},
 {name:"ãƒ­ãƒ¼ãƒ«ã‚­ãƒ£ãƒ™ãƒ„",pts:1,need:{"è±šè‚‰":1,"ã‚­ãƒ£ãƒ™ãƒ„":1}},
 {name:"ãƒãƒŠãƒŠã‚¸ãƒ¥ãƒ¼ã‚¹",pts:1,need:{"ãƒãƒŠãƒŠ":1,"ç‰›ä¹³":1}},
 {name:"é®­ãŠã«ãã‚Š",pts:2,need:{"ã”é£¯":1,"ã®ã‚Š":1,"é­šè‚‰":1}},
 {name:"é‡èœç‚’ã‚",pts:2,need:{"ã‚­ãƒ£ãƒ™ãƒ„":1,"ã«ã‚“ã˜ã‚“":1,"ç‰ã­ã":1}},
 {name:"ãƒãƒ£ãƒ¼ãƒãƒ³",pts:2,need:{"ã”é£¯":1,"ç‰ã­ã":1,"åµ":1}},
 {name:"è±ªè¯ãªãƒãƒ£ãƒ¼ãƒãƒ³",pts:4,need:{"ã”é£¯":1,"ç‰ã­ã":1,"åµ":1,"è±šè‚‰":1}},
 {name:"ã‚­ãƒ¼ãƒã‚«ãƒ¬ãƒ¼",pts:4,need:{"ã”é£¯":1,"ç‰ã­ã":1,"ã‚«ãƒ¬ãƒ¼ç²‰":1,"ç‰›è‚‰":1}},
 {name:"ã‚ªãƒ ãƒ©ã‚¤ã‚¹",pts:4,need:{"ã”é£¯":1,"ç‰ã­ã":1,"åµ":1,"é¶è‚‰":1}},
 {name:"ãƒãƒ³ãƒãƒ¼ã‚°",pts:4,need:{"ç‰›è‚‰":1,"è±šè‚‰":1,"ç‰ã­ã":1,"ç‰›ä¹³":1}},
 {name:"è‚‰ã˜ã‚ƒãŒ",pts:4,need:{"ç‰›è‚‰":1,"ã˜ã‚ƒãŒã„ã‚‚":1,"ç‰ã­ã":1,"ã«ã‚“ã˜ã‚“":1}},
 {name:"ã‚¯ãƒªãƒ¼ãƒ ã‚·ãƒãƒ¥ãƒ¼",pts:7,need:{"ç‰›ä¹³":1,"ç‰›è‚‰":1,"ç‰ã­ã":1,"ã«ã‚“ã˜ã‚“":1,"ã˜ã‚ƒãŒã„ã‚‚":1}},
 {name:"ã‚«ãƒ¬ãƒ¼",pts:7,need:{"ç‰›è‚‰":1,"ç‰ã­ã":1,"ã«ã‚“ã˜ã‚“":1,"ã˜ã‚ƒãŒã„ã‚‚":1,"ã‚«ãƒ¬ãƒ¼ç²‰":1}},
 {name:"æº€è…¹ã‚«ãƒ¬ãƒ¼",pts:10,need:{"ã”é£¯":1,"ç‰›è‚‰":1,"ç‰ã­ã":1,"ã«ã‚“ã˜ã‚“":1,"ã˜ã‚ƒãŒã„ã‚‚":1,"ã‚«ãƒ¬ãƒ¼ç²‰":1}},
 {name:"çˆ†å¼¾ãŠã«ãã‚Š",pts:10,need:{"ã”é£¯":4,"ã®ã‚Š":1,"é­šè‚‰":1}}
];

/* ===== ä¾¿åˆ© ===== */
function $(id){return document.getElementById(id)}
function log(t){var el=$('log');var tm=new Date().toLocaleTimeString();el.innerHTML+='<div><span style="color:#94a3b8">'+tm+'</span>ï¼š<b>'+t+'</b></div>';el.scrollTop=el.scrollHeight;}
function shuffle(a){var r=a.slice();for(var i=r.length-1;i>0;i--){var j=(Math.random()*(i+1))|0;var tmp=r[i];r[i]=r[j];r[j]=tmp;}return r;}
function countByName(list){var m={};for(var i=0;i<list.length;i++){var n=list[i].name;m[n]=(m[n]||0)+1;}return m;}
function clone(o){return JSON.parse(JSON.stringify(o));}

/* ===== çŠ¶æ…‹ ===== */
var S=null;

function makeDeck(){
  var d=[];
  Object.keys(MATERIAL_COUNTS).forEach(function(n){for(var i=0;i<MATERIAL_COUNTS[n];i++) d.push({kind:"mat",name:n});});
  for(var i=0;i<EVENTS.length;i++) for(var k=0;k<2;k++) d.push({kind:"evt",name:EVENTS[i].name,id:EVENTS[i].id});
  return shuffle(d);
}

function newGame(){
  S={deck:makeDeck(),discard:[],turn:'you',gameOver:false,
     firstTurnEventLock:{you:true,cpu:false},
     you:{hand:[],set:[],pts:0,procs:[],meats:{},evtUsed:false,turnLock:false,craftedThisTurn:0},
     cpu:{hand:[],set:[],pts:0,procs:[],meats:{},evtUsed:false,turnLock:false,craftedThisTurn:0}};
  for(var i=0;i<4;i++){ draw('you'); draw('cpu'); }
  $('log').innerHTML='';
  log('ğŸ¬ ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ã‚ãªãŸãŒå…ˆæ”»ã€‚å…ˆæ‰‹åˆæ‰‹ã¯ã‚¤ãƒ™ãƒ³ãƒˆä½¿ç”¨ä¸å¯ã€‚');
  startTurn();
  render();
}

function draw(who){
  var limit = hasProc(who,'board')?5:4;
  while(S[who].hand.length<limit){
    if(S.deck.length===0){
      if(S.discard.length===0) break;
      S.deck=shuffle(S.discard);S.discard=[];
      log('â™»ï¸ å±±æœ­ã‚’å†æ§‹æˆã—ã¾ã—ãŸ');
    }
    S[who].hand.push(S.deck.pop());
  }
}

function startTurn(){
  var who=S.turn; S[who].evtUsed=false; S[who].turnLock=false; S[who].craftedThisTurn=0;
  draw(who); render();
  if(who==='cpu' && !S.gameOver) setTimeout(cpuAct,600);
}

function endTurn(){
  if(S.gameOver) return;
  var who=S.turn;
  if(S[who].hand.length>2){
    if(who==='you'){ openKeepModal(); return; }
    cpuDiscardToTwo();
  }
  S.turn=(S.turn==='you')?'cpu':'you';
  S.firstTurnEventLock[S.turn]=false;
  render(); startTurn();
}

/* ===== å½¹ä½œã‚Š ===== */
function hasProc(who,id){return S[who].procs.indexOf(id)>=0}
function canCraft(who,rec){
  var pool=S[who].hand.concat(S[who].set), cnt=countByName(pool), need=clone(rec.need);
  var ok=true,i; for(i in need){ if((cnt[i]||0)<need[i]){ok=false;break;} }
  if(ok) return {ok:true,use:chooseUse(who,need)};
  if(!hasProc(who,'knife')) return {ok:false};
  for(i in need){ var n2=clone(need); n2[i]=Math.max(0,n2[i]-1); var ok2=true,j; for(j in n2){ if((cnt[j]||0)<n2[j]){ok2=false;break;} }
    if(ok2) return {ok:true,use:chooseUse(who,n2)};
  }
  return {ok:false};
}
function chooseUse(who,need){
  var fromSet=[],fromHand=[], needCnt=clone(need), s=S[who].set, h=S[who].hand, i;
  for(i=0;i<s.length;i++){ var nm=s[i].name; if(needCnt[nm]>0){needCnt[nm]--;fromSet.push({idx:i});}}
  for(i=0;i<h.length;i++){ var n2=h[i].name; if(needCnt[n2]>0){needCnt[n2]--;fromHand.push({idx:i});}}
  return {fromSet:fromSet,fromHand:fromHand};
}
function doCraft(rec){
  var who=S.turn; if(S[who].turnLock){alert('ã“ã®ã‚¿ãƒ¼ãƒ³ã¯å½¹ã‚’ä½œã‚Œã¾ã›ã‚“');return;}
  var chk=canCraft(who,rec); if(!chk.ok){alert('ææ–™ä¸è¶³');return;}
  var i;
  var sidx=chk.use.fromSet.map(function(x){return x.idx}).sort(function(a,b){return b-a});
  for(i=0;i<sidx.length;i++) S.discard.push(S[who].set.splice(sidx[i],1)[0]);
  var hidx=chk.use.fromHand.map(function(x){return x.idx}).sort(function(a,b){return b-a});
  for(i=0;i<hidx.length;i++) S.discard.push(S[who].hand.splice(hidx[i],1)[0]);
  S[who].pts+=rec.pts; S[who].craftedThisTurn++;
  ["é¶è‚‰","è±šè‚‰","ç‰›è‚‰","é­šè‚‰"].forEach(function(m){ if(rec.need[m]) S[who].meats[m]=true; });
  log('ğŸ½ï¸ '+label(who)+'ãŒã€Œ'+rec.name+'ã€å®Œæˆï¼ˆ'+rec.pts+'ç‚¹ï¼‰');
  if(S[who].pts>=10){ over(label(who)+'ã®å‹åˆ©ï¼ï¼ˆ10ç‚¹ï¼‰'); return; }
  if(Object.keys(S[who].meats).length===4 && S[who].pts>=7){ over(label(who)+'ãŒã€Œæ–™ç†ã®é‰„äººã€é”æˆï¼'); return; }
  if(S[who].craftedThisTurn>=3){ over(label(who)+'ãŒã€Œæº€è…¹ã®é”äººã€é”æˆï¼'); return; }
  render();
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
function canUseEvent(who){ return !S[who].evtUsed && !S.firstTurnEventLock[who]; }
function useEvent(idx){
  var who='you', c=S[who].hand[idx]; if(!c||c.kind!=='evt')return;
  if(!canUseEvent(who)){alert('ã“ã®ã‚¿ãƒ¼ãƒ³ã¯ã‚¤ãƒ™ãƒ³ãƒˆä½¿ç”¨ä¸å¯');return;}
  var ev=null; for(var i=0;i<EVENTS.length;i++) if(EVENTS[i].name===c.name) ev=EVENTS[i];
  if(!ev) return;
  switch(ev.id){
    case "ã”ã¿":{
      var mats=S.discard.filter(function(x){return x.kind==='mat'}); if(mats.length===0){log('ğŸš› ã‚´ãƒŸç®±ã«ææ–™ãªã—');break;}
      var t=mats[0]; // ç°¡æ˜“ï¼šå…ˆé ­
      var di=S.discard.findIndex?S.discard.findIndex(function(x){return x.kind==='mat' && x.name===t.name}):S.discard.indexOf(t);
      if(di>=0){ var got=S.discard.splice(di,1)[0]; S[who].hand.push(got); log('ğŸš› ã‚´ãƒŸåé›†è»Šï¼š'+got.name+' ã‚’å›å');}
      break;
    }
    case "ç‰©ã€…":{
      var opp='cpu';
      var oppM=S[opp].hand.filter(function(x){return x.kind==='mat'});
      if(oppM.length){ var take=oppM[(Math.random()*oppM.length)|0]; var oi=S[opp].hand.indexOf(take); S[opp].hand.splice(oi,1); S[who].hand.push(take);
        var myMatIdx=S[who].hand.findIndex?S[who].hand.findIndex(function(x){return x.kind==='mat'}):-1;
        if(myMatIdx>=0){ var give=S[who].hand.splice(myMatIdx,1)[0]; S[opp].hand.push(give); log('ğŸ” ç‰©ã€…äº¤æ›ï¼š'+take.name+' â‡” '+give.name); }
        else log('ğŸ” ç‰©ã€…äº¤æ›ï¼š'+take.name+' ã‚’ã‚‚ã‚‰ã£ãŸï¼ˆæ¸¡ã™ææ–™ãªã—ï¼‰');
      }else log('ğŸ” ç›¸æ‰‹ã«ææ–™ãŒãªã„');
      break;
    }
    case "ã‚„ã‚":{
      var n=S[who].set.length; while(S[who].set.length) S[who].hand.push(S[who].set.pop());
      log('â†©ï¸ ã‚„ã£ã±ã‚„ãƒ¼ã‚ãŸã£ï¼ï¼š'+n+'æšå›å'); break;
    }
    case "ã‚„ã‚Š":{
      var n2=S[who].hand.length; Array.prototype.push.apply(S.discard,S[who].hand.splice(0));
      for(i=0;i<n2;i++){ if(S.deck.length===0){S.deck=shuffle(S.discard);S.discard=[];} if(S.deck.length===0)break; S[who].hand.push(S.deck.pop()); }
      log('ğŸ”„ ã‚„ã‚Šç›´ã—'); break;
    }
    case "å‰µä½œ":{
      var mats=S[who].hand.filter(function(x){return x.kind==='mat'}); if(mats.length<2){alert('ææ–™2æšãŒå¿…è¦');return;}
      // å…ˆé ­2æšæ¨ã¦ã¦3ç‚¹
      var dumped=0, keep=[]; for(i=0;i<S[who].hand.length;i++){var cc=S[who].hand[i]; if(cc.kind==='mat' && dumped<2){S.discard.push(cc);dumped++;} else keep.push(cc);}
      S[who].hand=keep; S[who].pts+=3; S[who].turnLock=true; log('âœ¨ å‰µä½œæ–™ç†ï¼š3ç‚¹ï¼ˆä»–ã®å½¹ä¸å¯ï¼‰'); if(S[who].pts>=10){over('ã‚ãªãŸã®å‹åˆ©ï¼ï¼ˆ10ç‚¹ï¼‰');return;}
      break;
    }
    case "çˆ†è²·":{
      for(i=0;i<3;i++){ if(S.deck.length===0){S.deck=shuffle(S.discard);S.discard=[];} if(S.deck.length===0)break; S[who].hand.push(S.deck.pop()); }
      log('ğŸ›’ çˆ†è²·ã„'); break;
    }
    case "æ¢ç´¢":{
      var open=[]; for(i=0;i<3;i++){ if(S.deck.length===0){S.deck=shuffle(S.discard);S.discard=[];} if(S.deck.length===0)break; open.push(S.deck.pop()); }
      var take=open.filter(function(x){return x.kind==='mat'}).slice(0,2), rest=open.filter(function(x){return take.indexOf(x)<0});
      Array.prototype.push.apply(S[who].hand,take); Array.prototype.push.apply(S.discard,rest);
      log('ğŸ” é£Ÿææ¢ç´¢ï¼š'+take.length+'æšå…¥æ‰‹'); break;
    }
    case "æƒé™¤":{
      var opp='cpu', n3=S[opp].hand.length; Array.prototype.push.apply(S.discard,S[opp].hand.splice(0));
      for(i=0;i<n3;i++){ if(S.deck.length===0){S.deck=shuffle(S.discard);S.discard=[];} if(S.deck.length===0)break; S[opp].hand.push(S.deck.pop()); }
      log('ğŸ§¹ å¤§æƒé™¤'); break;
    }
    case "ç·Šæ€¥":{
      if(S[who].pts>5){alert('è‡ªç‚¹5ä»¥ä¸‹ã®ã¿');return;}
      var mIdx=S[who].hand.findIndex?S[who].hand.findIndex(function(x){return x.kind==='mat'}):-1;
      if(mIdx<0){alert('ææ–™ãŒå¿…è¦');return;}
      S.discard.push(S[who].hand.splice(mIdx,1)[0]); S[who].pts+=3; S[who].turnLock=true; log('â± ç·Šæ€¥èª¿ç†ï¼š3ç‚¹'); if(S[who].pts>=10){over('ã‚ãªãŸã®å‹åˆ©ï¼ï¼ˆ10ç‚¹ï¼‰');return;}
      break;
    }
  }
  S.discard.push(S[who].hand.splice(idx,1)[0]); S[who].evtUsed=true; render();
}

/* ===== ã‚»ãƒƒãƒˆ & åŠ å·¥ ===== */
function setMaterial(idx){
  var who='you', limit=hasProc(who,'freezer')?3:2;
  if(S[who].set.length>=limit){alert('ã‚»ãƒƒãƒˆä¸Šé™ã¯'+limit+'æš');return;}
  var c=S[who].hand[idx]; if(!c||c.kind!=='mat'){alert('ææ–™ã®ã¿ã‚»ãƒƒãƒˆå¯èƒ½');return;}
  S[who].set.push(c); S[who].hand.splice(idx,1); render();
}
function canBuyProc(who,id){return S[who].procs.indexOf(id)<0 && S[who].pts>=3}
function buyProc(id){
  var who='you'; if(!canBuyProc(who,id)){alert('è³¼å…¥ã§ãã¾ã›ã‚“');return;}
  S[who].pts-=3; S[who].procs.push(id); log('ğŸ› ï¸ '+label(who)+'ãŒã€Œ'+id+'ã€ã‚’ç²å¾—ï¼ˆ-3ç‚¹ï¼‰'); render();
}

/* ===== å‹æ•— ===== */
function label(w){return w==='you'?'ã‚ãªãŸ':'CPU'}
function over(msg){S.gameOver=true;log('ğŸ† '+msg); alert('ã‚²ãƒ¼ãƒ çµ‚äº†ï¼š'+msg);}

/* ===== è¡¨ç¤º ===== */
function render(){
  $('deckN').textContent=S.deck.length; $('discN').textContent=S.discard.length;
  $('turnLabel').textContent=label(S.turn); $('evtRest').textContent=S[S.turn].evtUsed?'ä½¿ç”¨æ¸ˆ':'OK';
  $('firstLock').textContent=S.firstTurnEventLock[S.turn]?'ç¦æ­¢ä¸­':'è§£é™¤';
  $('cpuHandN').textContent=S.cpu.hand.length; $('cpuSetN').textContent=S.cpu.set.length; $('cpuPts').textContent=S.cpu.pts;
  $('youHandN').textContent=S.you.hand.length; $('youSetN').textContent=S.you.set.length; $('youPts').textContent=S.you.pts;
  renderProcs('cpuProcs',S.cpu.procs); renderProcs('youProcs',S.you.procs);
  var cset=$('cpuSet'); cset.innerHTML=''; for(var i=0;i<S.cpu.set.length;i++){var b=document.createElement('div'); b.className='back'; b.textContent='ğŸ‚ '; cset.appendChild(b);}
  var yhand=$('youHand'); yhand.innerHTML='';
  for(var i=0;i<S.you.hand.length;i++){ (function(i){
    var c=S.you.hand[i]; var el=document.createElement('div'); el.className='card';
    el.innerHTML='<div class="name">'+c.name+'</div><div class="mut">'+(c.kind==='mat'?'ææ–™':'ã‚¤ãƒ™ãƒ³ãƒˆ')+'</div><div class="hr"></div>';
    var b1=document.createElement('button'); b1.className='btn'; if(c.kind==='mat'){b1.textContent='ã‚»ãƒƒãƒˆ'; b1.onclick=function(){setMaterial(i)};}
    else {b1.textContent='ç™ºå‹•'; b1.onclick=function(){useEvent(i)};}
    el.appendChild(b1); yhand.appendChild(el);
  })(i);}
  var yset=$('youSet'); yset.innerHTML=''; for(i=0;i<S.you.set.length;i++){var el2=document.createElement('div'); el2.className='back'; el2.textContent='ğŸ‚ '; yset.appendChild(el2);}
}
function renderProcs(id,list){
  var el=$(id); el.innerHTML=''; for(var i=0;i<PROCS.length;i++){var t=document.createElement('div'); t.className='tag'+(list.indexOf(PROCS[i].id)>=0?' on':''); t.textContent=PROCS[i].name; el.appendChild(t);}
}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆdialogä»£æ›¿ï¼‰ ===== */
function showModal(id){$(id).style.display='flex'} function closeModal(id){$(id).style.display='none'}

function openCraft(){ if(S.turn!=='you'||S.gameOver) return;
  var cont=$('craftList'); cont.innerHTML='';
  RECIPES.forEach(function(r){
    var ok=canCraft('you',r).ok; var d=document.createElement('div'); d.className='choice';
    d.innerHTML='<div><b>'+r.name+'ï¼ˆ'+r.pts+'ç‚¹ï¼‰</b><div class="mut">'+Object.keys(r.need).map(function(k){return k+'Ã—'+r.need[k]}).join(' , ')+'</div></div>';
    var b=document.createElement('button'); b.className='btn'; b.textContent= ok?'ä½œã‚‹':'ä¸è¶³'; if(!ok) b.disabled=true;
    b.onclick=function(){doCraft(r); render();}; d.appendChild(document.createElement('div')).appendChild(b); cont.appendChild(d);
  }); showModal('modalCraft');
}
function openBuy(){ if(S.turn!=='you'||S.gameOver) return;
  var cont=$('buyList'); cont.innerHTML='';
  PROCS.forEach(function(p){
    var d=document.createElement('div'); d.className='choice'; d.innerHTML='<b>'+p.name+'</b><div class="mut">'+p.desc+'</div>';
    var b=document.createElement('button'); b.className='btn'; b.textContent=hasProc('you',p.id)?'æ‰€æŒæ¸ˆ':'3ç‚¹ã§ç²å¾—'; if(hasProc('you',p.id)||S.you.pts<3) b.disabled=true;
    b.onclick=function(){buyProc(p.id)}; d.appendChild(document.createElement('div')).appendChild(b); cont.appendChild(d);
  }); showModal('modalBuy');
}
$('closeCraft').onclick=function(){closeModal('modalCraft')}
$('closeBuy').onclick=function(){closeModal('modalBuy')}

function openKeepModal(){
  var cont=$('keepList'); cont.innerHTML='';
  var sel={}; S.you.hand.forEach(function(c,idx){
    var d=document.createElement('div'); d.className='choice'; d.innerHTML='<b>'+c.name+'</b><div class="mut">'+(c.kind==='mat'?'ææ–™':'ã‚¤ãƒ™ãƒ³ãƒˆ')+'</div>';
    d.onclick=function(){ if(sel[idx]){ delete sel[idx]; d.classList.remove('sel'); } else { sel[idx]=true; d.classList.add('sel'); } };
    cont.appendChild(d);
  });
  $('confirmKeep').onclick=function(){
    var keep=Object.keys(sel).map(function(x){return +x}); if(keep.length!==2){alert('2æšã ã‘é¸ã‚“ã§ã­');return;}
    keep.sort(function(a,b){return a-b}); var nh=[S.you.hand[keep[0]], S.you.hand[keep[1]]];
    for(var i=0;i<S.you.hand.length;i++){ if(keep.indexOf(i)<0) S.discard.push(S.you.hand[i]); }
    S.you.hand=nh; closeModal('modalKeep'); S.turn='cpu'; render(); startTurn();
  };
  showModal('modalKeep');
}

/* ===== CPU ===== */
function cpuAct(){
  var me='cpu';
  // 1) ä½œã‚Œã‚‹å½¹ â†’ æœ€å¤§ç‚¹ã‹ã‚‰
  var cands=RECIPES.filter(function(r){return canCraft(me,r).ok}).sort(function(a,b){return b.pts-a.pts});
  if(cands.length){ doCraftCPU(cands[0]); if(S.gameOver) return;
    var more=RECIPES.filter(function(r){return canCraft(me,r).ok}); if(more.length && Math.random()<0.5){setTimeout(cpuAct,400);return;}
    setTimeout(endTurn,400); return; }
  // 2) åŒ…ä¸ãŒãªãç‚¹3ä»¥ä¸Šãªã‚‰è²·ã†
  if(S.cpu.pts>=3 && S.cpu.procs.indexOf('knife')<0 && S.cpu.hand.filter(function(c){return c.k

<script src="game.js"></script>
  <script>
    window.onload = function() {
      newGame();
    };
  </script>
</body>
</html>